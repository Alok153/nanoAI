openapi: 3.0.3
info:
  title: nanoAI Stabilization Operational Contracts (Manifest & Credentials)
  version: 0.1.0
servers:
  - url: https://api.nanoai.app
    description: Production catalog
  - url: https://staging.nanoai.app
    description: Staging catalog for QA
paths:
  /catalog/models/{modelId}/manifest:
    get:
      summary: Retrieve the signed manifest for a specific model version
      operationId: getModelManifest
      parameters:
        - name: modelId
          in: path
          required: true
          schema:
            type: string
        - name: version
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Manifest found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelManifest'
        '404':
          description: Manifest missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /catalog/models/{modelId}/verify:
    post:
      summary: Submit checksum verification result after download
      operationId: verifyModelPackage
      parameters:
        - name: modelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManifestVerificationRequest'
      responses:
        '200':
          description: Verification recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManifestVerificationResponse'
        '409':
          description: Checksum mismatch detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /credentials/providers/{providerId}:
    post:
      summary: Create or rotate provider credential and return encrypted storage metadata
      operationId: rotateProviderCredential
      parameters:
        - name: providerId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecretCredentialRequest'
      responses:
        '201':
          description: Credential stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecretCredentialResponse'
        '400':
          description: Invalid payload or unsupported provider
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
components:
  schemas:
    ModelManifest:
      type: object
      required:
        - modelId
        - version
        - checksumSha256
        - sizeBytes
        - downloadUrl
        - signature
      properties:
        modelId:
          type: string
          example: persona-text-delta
        version:
          type: string
          example: 1.2.0
        checksumSha256:
          type: string
          pattern: '^[0-9a-fA-F]{64}$'
          example: 9f2a8a4c7cb0a2aa73ec718f7f9b0d4c70bda2f286f7f0bb7b3b92d4abf65c2e
        sizeBytes:
          type: integer
          format: int64
          minimum: 1
          example: 524288000
        downloadUrl:
          type: string
          format: uri
          example: https://cdn.nanoai.app/model/persona-text-delta-1.2.0.tgz
        signature:
          type: string
          description: Base64-encoded detached signature for manifest verification
        expiresAt:
          type: string
          format: date-time
    ManifestVerificationRequest:
      type: object
      required:
        - version
        - checksumSha256
        - deviceId
        - verifiedAt
      properties:
        version:
          type: string
        checksumSha256:
          type: string
          pattern: '^[0-9a-fA-F]{64}$'
        deviceId:
          type: string
          description: Stable identifier hashed with installation ID
        verifiedAt:
          type: string
          format: date-time
        status:
          type: string
          enum: [SUCCESS, CORRUPTED]
        failureReason:
          type: string
          nullable: true
    ManifestVerificationResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [ACCEPTED, RETRY]
        nextRetryAfterSeconds:
          type: integer
          format: int32
          minimum: 0
          description: Populated when status is RETRY.
    SecretCredentialRequest:
      type: object
      required:
        - environment
        - encryptedKey
      properties:
        environment:
          type: string
          enum: [production, staging, sandbox]
        encryptedKey:
          type: string
          description: Client-side encrypted payload using project public key
        rotatesAfter:
          type: string
          format: date-time
          nullable: true
        scopes:
          type: array
          items:
            type: string
            enum: [TEXT_INFERENCE, VISION, AUDIO, EXPORT]
    SecretCredentialResponse:
      type: object
      required:
        - providerId
        - storedAt
        - keyAlias
      properties:
        providerId:
          type: string
        storedAt:
          type: string
          format: date-time
        keyAlias:
          type: string
        rotatesAfter:
          type: string
          format: date-time
          nullable: true
        migrationRequired:
          type: boolean
          description: When true, client should trigger local migration routine.
    ErrorEnvelope:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          enum: [NETWORK_UNAVAILABLE, INTEGRITY_FAILURE, AUTH_REQUIRED, RATE_LIMITED, UNKNOWN]
        message:
          type: string
        retryAfterSeconds:
          type: integer
          format: int32
          nullable: true
        telemetryId:
          type: string
          nullable: true
        details:
          type: object
          additionalProperties:
            type: string
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
security:
  - ApiKeyAuth: []
